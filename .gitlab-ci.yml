# GitLab CI configuration for hostenv
#
# This runs Nix flake checks on every merge request and push to main
# to ensure code quality and prevent regressions.

image: nixos/nix:latest

variables:
  NIX_CONFIG: "experimental-features = nix-command flakes"

# Enable Nix flakes and configure binary cache
before_script:
  - nix profile add --accept-flake-config nixpkgs#cachix
  - cachix use fossar
  - cachix use hostenv
  - cachix authtoken "$cachix_token"

stages:
  - check

# Job: Run nix flake check
# This validates flake structure and runs all checks defined in checks.*
flake-check:
  stage: check
  script:
    - nix flake check --show-trace --print-build-logs
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - saas-linux-small-arm64

# Nightly updates and builds.
# Note: to start updates are run nightly and are automatically committed to
# main, this will hold while the project is in early development, however,
# this should change as hostenv matures.
#
# Further into the project we will slow the cadence (to weekly updates?),
# use a stable version of nixpkgs, and move to using MRs for updates instead
# of slinging changes onto main.
#
# It's worth noting that downstream projects won't especially be affected by
# these updates as they have their own `flake.lock` files that lock nixpkgs.
nightly-full-check:
  stage: check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  script:
    - |
        set -euo pipefail
        git checkout main
        nix flake update
        if ! git diff --quiet --exit-code; then
          nix flake check --show-trace --print-build-logs
          git config --global user.name "Patch Bot"
          git config --global user.email "patch-bot@hostenv.sh"
          git commit -m "(chore) update flake.lock dependencies" flake.lock
          git push "https://SelfCI:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
        else
          echo "No updates available"
        fi
  tags:
    - saas-linux-small-arm64
  allow_failure: true
