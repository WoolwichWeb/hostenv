# GitLab CI configuration for hostenv
#
# This runs Nix flake checks on every merge request and push to main
# to ensure code quality and prevent regressions.

image: nixos/nix:latest

# Enable Nix flakes and configure binary cache
before_script:
  - mkdir -p ~/.config/nix .nix-cache
  - echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf
  # Use local file cache in addition to the official cache
  - echo "extra-substituters = file://$PWD/.nix-cache" >> ~/.config/nix/nix.conf
  # Trust the local cache (needed for file:// substituters)
  - echo "trusted-substituters = file://$PWD/.nix-cache" >> ~/.config/nix/nix.conf
  # Export built paths to the cache after each job
  - echo "post-build-hook = $PWD/.gitlab-cache-hook.sh" >> ~/.config/nix/nix.conf
  # Create the post-build hook script
  - |
    cat > .gitlab-cache-hook.sh << 'EOF'
    #!/bin/sh
    set -eu
    set -f # disable globbing
    export IFS=' '
    echo "Caching paths: $OUT_PATHS"
    exec nix copy --to "file://$PWD/.nix-cache" $OUT_PATHS
    EOF
  - chmod +x .gitlab-cache-hook.sh

# Cache Nix store between runs to speed up builds
# This caches built derivations in .nix-cache/ which is restored on subsequent runs
cache:
  key: nix-store
  paths:
    - .nix-cache/

stages:
  - check

# Job: Run nix flake check
# This validates flake structure and runs all checks defined in checks.*
flake-check:
  stage: check
  script:
    - nix flake check --show-trace
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags:
    - saas-linux-small-arm64

# Nightly updates and builds.
# Note: to start updates are run nightly and are automatically committed to
# main, this will hold while the project is in early development, however,
# this should change as hostenv matures.
#
# Further into the project we will slow the cadence (to weekly updates?),
# use a stable version of nixpkgs, and probably move to using MRs for updates
# instead of slinging changes onto main.
#
# It's worth noting that downstream projects won't especially be affected by
# these updates as they have their own `flake.lock` files that lock nixpkgs.
nightly-full-check:
  stage: check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  script:
    - git checkout main
    - nix flake update
    - if ! git diff --quiet --exit-code; then
        nix flake check --show-trace --all-systems || exit 1;
        git config --global user.name "Gitlab CI";
        git config --global user.email "";
        git commit -m "(chore) update flake.lock dependencies" flake.lock;
        git push "https://SelfCI:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git";
      else
        echo "No updates available"
      fi
  tags:
    - saas-linux-small-arm64
  allow_failure: true
