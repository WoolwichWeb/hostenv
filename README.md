# Hostenv

*Wow, you found hostenv before it was cool.*

hostenv isn't quite ready for general use yet, but we're getting close! In
the meantime, feel free to explore the codebase, browse the Nix modules, or
open issues and merge requests.

Contributions and curiosity are both welcome.

---

## What is hostenv?

**hostenv** is a Platform as a Service (PaaS) that belongs to all of us.

It lets you define your hosting environment declaratively, using a JSON-like
configuration language (Nix). Instead of writing deployment scripts, you
describe what you want and hostenv builds the environment for you.

Here's an example hosting environment for the
[Drupal](https://www.drupal.org) CMS:

```nix
# hostenv.nix
{ pkgs, config, ... }: {

  services.drupal.enable = true;
  services.drupal.phpVersion = "8.3";

  # Run cron every five minutes.
  services.drupal.cron.timerConfig.OnCalendar = "*:0/5";

  environments.main = {
    enable = true;
    type = "production";
    virtualHosts = {
      "example.com" = {
        globalRedirect = "www.example.com";
      };
      "www.example.com" = {
        locations."/old-url" = {
          redirect = "/new-url";
        };
      };
    };
  };

  environments.test = {
    enable = true;
    type = "testing";
  };
}
```

And here's the same idea for a simple PHP application using the built‑in
`php-app` module:

```nix
{ pkgs, config, ... }: {
  services.php-app.enable = true;
  services.php-app.codebase.name = "hello-php";

  environments.main = {
    enable = true;
    type = "production";
    virtualHosts."hello.example.com" = { };
  };
}
```

---

## Getting Started (for projects)

**Audience:** developers setting up hosting for a project.

1. **Install Nix**  
   Follow the [Nix installation guide](https://nixos.org/download/#download-nix).

2. **Initialise your hostenv project**  
   Inside your project directory, run:

   ```bash
   nix --extra-experimental-features "nix-command flakes" flake init --template gitlab:woolwichweb/hostenv#project
   ```

3. **Install and configure direnv**  
   [Install direnv](https://direnv.net/docs/installation.html) and set up the shell hook.  
   To setup the Shell hook for **Bash**, you would run:

   ```bash
   echo 'eval "$(direnv hook bash)"' >> ~/.bashrc
   ```

   (For other shells, see the [direnv hook documentation](https://direnv.net/docs/hook.html).)

4. **Configure hostenv**  
   Edit `.hostenv/hostenv.nix` and set options for your project.

5. **Make hostenv visible to Nix**  
   Since Nix only includes tracked files, run:

   ```bash
   git add .hostenv
   ```

6. **Allow direnv to build your environment**

   ```bash
   cd .hostenv
   direnv allow
   ```

7. **Wait for hostenv to build bespoke tooling**  
   Hostenv will prepare an environment and CLI tailored to your project.

8. **Run hostenv commands**  
   From your project directory, run:

   ```bash
   hostenv
   ```

   to see available commands.

9. **Enjoy automatic integration**  
   Once deployed, tools such as `drush` and `mysql` will *JustWork™* with the
   remote environment; no need to manage SSH or tunnels manually, just
   `cd .hostenv` then `drush`.

## Getting Started (for hosting providers)

**Audience:** People starting their own hostenv hosting provider.

**Important note:** This section is incomplete and is in flux, since we're
still working on improvements to Provider support.

1. **Install Nix**  
   Follow the [Nix installation guide](https://nixos.org/download/#download-nix).

2. **Initialise your hostenv project**  
   Inside your project directory, run:

   ```bash
   nix --extra-experimental-features "nix-command flakes" flake init --template gitlab:woolwichweb/hostenv#provider
   ```

3. **Create NixOS node configuration**
   Under `nodes/<node>/configuration.nix` add your servers' configuration (plus hardware config).

4. **Make flake inputs for projects**
   Add flake inputs for each project you're hosting:

   ```nix
   inputs = {
    # ... nixpkgs, flake-parts, hostenv, etc. from the template ...
    org__project = {
      url = "gitlab:org/project?dir=.hostenv&ref=main";
    };
   };
   ```

   Notes:

   - The `org` and `project` can be whatever you choose, however, these
     directly affect the URL generated by hostenv for each environment.
   - See the template flake's inputs (generated in step #2) for an example.
   - The input's `url` points to the git repo containing the project's code
     and `.hostenv/flake.nix`.
   - It may be necessary to get an access token for your client's project
     repo. See the Nix documentation for instructions on using gitlab/github
     tokens for access to private repositories.
   - Hostenv uses a single branch as the canonical list of environments and
     their SSH keys. It's possible to add environments in other branches'
     `hostenv.nix`, but these will be ignored until they're merged into that
     canonical branch. This branch is set using `ref=` in the project input.
     For instance, in the above example the canonical branch for `org__project`
     is `main`.

5. **Generate plan/state/flake**

   ```bash
   nix run .#hostenv-provider -- plan
   ```

   This writes: `generated/{flake.nix,plan.json,state.json}`.

   ```bash
   nix run .#hostenv-provider -- dns-gate
   ```

   This updates `plan.json` so Let's Encrypt is disabled for any environments
   where the DNS does not point to the correct server. This prevents
   entire deployments failing when ACME systemd units cannot start.

   @TODO: `nix run .#hostenv-provider` is capable of updating Cloudflare
   DNS records automatically, which should be documented here.

6. **Deploy**

  Deployments are driven by comin-enabled nodes consuming deploy intents
  produced by the provider service. Ensure `provider.comin.*` is configured
  and the provider webhook service is running.

---

## Contributing

We don't have formal contribution guidelines yet, but we welcome all kinds of
help. Whether it's a merge request, bug report, documentation improvement, or
a question about how something works.

If you see something that could be better, feel free to open an issue or
submit an MR (merge request). We'll work things out together as the
project grows.
